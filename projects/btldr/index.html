<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Jack's blog and portfolio."><link rel="shortcut icon" href=https://blog.jackgreenberg.co/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>CAN Software Update Bootloader</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet></head><body><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><header class=banner><h2><a href=https://blog.jackgreenberg.co>Jack Greenberg</a></h2><nav><ul><li><a href=/about/ title=about>about</a></li><li><a href=/projects/ title=projects>projects</a></li><li><a href=/resume.pdf title=resume>resume</a></li><li><button id=toggle-dark><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button></li></ul></nav></header><main id=content><aside id=toc><h4>Table of Contents</h4><nav id=TableOfContents><ul><li><a href=#about>About</a></li><li><a href=#motivation>Motivation</a></li><li><a href=#design>Design</a><ul><li><a href=#1-startup>1. Startup</a></li><li><a href=#2-update>2. Update</a></li></ul></li></ul></nav></aside><article><header id=post-header><h1>CAN Software Update Bootloader</h1><div><time>August 10, 2022</time></div></header><details id=toc-inline><summary><b>Table of Contents</b></summary><nav id=TableOfContents><ul><li><a href=#about>About</a></li><li><a href=#motivation>Motivation</a></li><li><a href=#design>Design</a><ul><li><a href=#1-startup>1. Startup</a></li><li><a href=#2-update>2. Update</a></li></ul></li></ul></nav></details><h2 id=about>About</h2><p><strong>Btldr</strong> is a bootloader for AVR microcontrollers that allows devices to have
their firmware updated using the CAN protocol. It goes along with client-side
<strong>updatr</strong> CLI which is used to send the binary to the target.</p><h2 id=motivation>Motivation</h2><p>While working on <em>Olin Electric Motorsports</em>, my college&rsquo;s FSAE electric race
car team, I was frustrated by the process of updating firmware. I was the lead
firmware engineer at the time, and anytime I wanted to tweak something, I had to
open up whatever enclosure the PCB was in, plug in a <em>USBASP</em> dongle to the
board, and run the update command.</p><p>This was sometimes dangerous as one of the enclosures also contained a 400V
battery with questionable harnessing. I started doing some research into
bootloaders after chatting with a few industry professionals, and after lots of
dead-ends and lots of &ldquo;ah-has&rdquo;, I finally understood what a bootloader was and
how to go about writing one.</p><h2 id=design>Design</h2><p>The ATMega16m1 has 16KB of flash memory, 1KB of SRAM, and 512 bytes of EEPROM.
Not exactly a lot. The flash is divided into two sections: <em>application</em> and
<em>bootloader</em> with configurable size. I configured the system so that the
bootloader section was 4KB, just to give myself as much room as necessary to
start. I will optimize from there. <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><h3 id=1-startup>1. Startup</h3><p>When the microcontroller resets or powers on, the bootloader is the first thing
to run. When this happens, we query EEPROM for a set of bootflags. One flag is
is used to indicate that a software update was requested. We&rsquo;ll get back to this
later. The other flag indicates that the image in the application section is
valid.</p><p>If an update wasn&rsquo;t requested and the image is valid (we will get to image
validity later), we jump to the application:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * The MCU&#39;s reset vector is 0x0000, and that performs initialization and then
</span></span></span><span class=line><span class=cl><span class=cm> * jumps to `main`.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>asm</span> <span class=nf>volatile</span><span class=p>(</span><span class=s>&#34;jmp 0x0000&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>If an update <em>was</em> requested, or the image in the application section isn&rsquo;t
&ldquo;valid&rdquo; (again, we&rsquo;ll revisit this), we enter continue the bootloader into the
updater image (not to be confused with <em>updatr</em>, the CLI that we&rsquo;ll discuss
later).</p><h3 id=2-update>2. Update</h3><p>In the updater image (which is really just an extension of the bootloader), we
initialize the CAN driver and start listening for messages. There are four types
of messages we can receive:</p><p><strong>QUERY</strong>: (base + 0) A request from the client for system information<br><strong>SESSION</strong>: (base + 2) A request from the client to start an update
session<br><strong>DATA</strong>: (base + 4) Contains chunks of the image to be flashed<br><strong>RESET</strong>: (base + 6) Instructs the target to reset itself by jumping back to
the bootloader</p><p>These four commands are the client-to-target side of the update protocol. The
&ldquo;base&rdquo; is the base ID assigned to each ECU on the CAN bus. For example, the BMS
is assigned a base of <code>0x710</code>, so the <strong>DATA</strong> message for the BMS would be
<code>0x714</code>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Plus, none of our firmware images are larger than 10KB, so we are not
hurting for space.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></main><footer id=footer>Copyright (c) 2022 Jack Greenberg</footer></body><script>let darkModeState=!1;const useDark=window.matchMedia("(prefers-color-scheme: dark)"),toggle_button=document.querySelector("#toggle-dark");function toggleDarkMode(e){document.documentElement.classList.toggle("dark-mode",e),darkModeState=e}toggleDarkMode(localStorage.getItem("dark-mode")=="true"),useDark.addListener(e=>toggleDarkMode(e.matches)),toggle_button.addEventListener("click",()=>{darkModeState=!darkModeState,toggleDarkMode(darkModeState),localStorage.setItem("dark-mode",darkModeState)})</script></html>